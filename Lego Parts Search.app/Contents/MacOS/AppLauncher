#!/bin/bash
set -e  # Exit on any error

# Get the directory of this script
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
APP_DIR="$( cd "$DIR/../.." && pwd )"
PARENT_DIR="$( cd "$APP_DIR/.." && pwd )"

# Create logs directory if it doesn't exist
mkdir -p "$PARENT_DIR/logs"

# Change to the parent directory
cd "$PARENT_DIR"

# Log the launch attempt
LOGFILE="$PARENT_DIR/logs/app_launcher.log"
echo "===== App Launch: $(date) =====" >> "$LOGFILE"
echo "Working directory: $(pwd)" >> "$LOGFILE"
echo "Python path: $(which python3)" >> "$LOGFILE"
echo "Environment:" >> "$LOGFILE"
env | sort >> "$LOGFILE"

# Make sure we have the right Python paths
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:$PATH"
export PYTHONPATH="$PARENT_DIR"
export DISPLAY=":0"
export PYTHONUNBUFFERED=1

# Launch in background and activate with AppleScript
echo "Launching Python in background and activating with AppleScript..." >> "$LOGFILE"
/usr/bin/env python3 "$PARENT_DIR/lego_parts_search.py" > "$LOGFILE" 2>&1 &

# Give Python a moment to start
sleep 0.5

# Run AppleScript to activate the application
echo "Running activation script..." >> "$LOGFILE"
osascript "$PARENT_DIR/activate_app.scpt" >> "$LOGFILE" 2>&1
